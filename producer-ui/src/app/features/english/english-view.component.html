<!-- producer.component.html -->
<div style="padding:16px" class="toolbar">
    <a class="btn btn-secondary" routerLink="/rundown">Open Service Rundown</a>
</div>
<!-- rest of producer template... -->

<div style="padding:16px; font-family:system-ui">
    <div class="titlebar">
        <h2>English Producer</h2>
        <div class="clock">
            <div class="clock-time">{{ etNow$ | async }} ET</div>
            <div class="clock-date">{{ etDate$ | async }}</div>
        </div>
    </div>

    <!-- status chip -->
    <div style="margin:8px 0; font-size:12px; opacity:.8">
        runId: <b>{{ runId || '—' }}</b> • connected: <b>{{ connected }}</b> • state?: <b>{{ !!state }}</b>
        <span *ngIf="connectErr" style="color:#dc2626"> (connect error)</span>
    </div>

    <!-- Live status / master countdown -->
    <div class="bar" *ngIf="vmView$ | async as vm">
        <ng-container *ngIf="vm.s?.masterStartAtUtc; else notStarted">
            <span class="dot" [class.live]="vm.mc > 0" [class.ended]="vm.mc <= 0"></span>
            <b [class.time-red]="vm.mc <= 0">Master Timer – {{ (vm.mc > 0 ? vm.mc : 0) | mmss }}</b>

            <small *ngIf="(hub.lastSyncAgo$ | async) as secs">
                Live • Updated
                <ng-container *ngIf="secs < 60">&lt;1m</ng-container>
                <ng-container *ngIf="secs >= 60">{{ (secs/60) | number:'1.0-0' }}m</ng-container>
                ago
            </small>
        </ng-container>
        <ng-template #notStarted>
            <b style="color:#3BB143">✅ Master Timer Ready (36 minutes)</b>
        </ng-template>
    </div>

    <!-- ================== LIVE (SignalR) ================== -->
    <ng-container *ngIf="state as s; else editorFallback">
        <p>
            <b>Spanish Sermon Status:</b>
            Time Left:
            <ng-container *ngIf="spanishTimeLeftSec() as rem; else tlDash">
                {{ rem | mmss }}
            </ng-container>
            <ng-template #tlDash>—</ng-template>
            |
            Sermon Ended At:
            <ng-container *ngIf="state?.spanish?.sermonEndedAtSec as fin; else finDash">
                {{ fin | mmss }}
                <small style="margin-left:8px; opacity:.9">
                    ({{ spanishEndedAtWallTime() | date:'h:mm a':'America/New_York' }})
                </small>
            </ng-container>
            <ng-template #finDash>—</ng-template>
        </p>

        <!-- Offering: Planned + Predicted -->
        <p>
            <b>Offering Length:</b>
            Planned: {{ s.baseOfferingSec | mmss }}
            |
            <ng-container *ngIf="predictedLengthSec(s) as pl">
                Predicted: {{ pl | mmss }}
                <ng-container *ngIf="predictedExtensionSec(s) as ext">
                    <small style="opacity:.8; margin-left:8px"> (+{{ ext | mmss }} included in prediction)</small>
                </ng-container>
            </ng-container>
        </p>

        <!-- Buttons -->
        <button (click)="startRun()" [disabled]="!!s.masterStartAtUtc">Start Run</button>
        <p>
            <button (click)="startOffering()" [disabled]="offeringClicked || isOfferingLocked(s)">
                Start Offering
            </button>
        </p>

        <!-- Segments (live) -->
        <div class="segments-wrap">
            <div class="segments-head">
                <h3>Segments</h3>
                <div class="total-drift">
                    <b>Total Drift:</b>
                    <span [style.color]="+(s.english.runningDriftBeforeOfferingSec ?? 0) < -4 ? 'red'
                    : +(s.english.runningDriftBeforeOfferingSec ?? 0) >  4 ? 'black'
                    : 'inherit'">
                        {{ s.english.runningDriftBeforeOfferingSec | signedmmss }}
                    </span>
                </div>
            </div>

            <table>
                <tr>
                    <th>#</th>
                    <th>Segment</th>
                    <th>Planned</th>
                    <th>Actual</th>
                    <th>Segment Drift</th>
                    <th>Action</th>
                    <th>Ended</th>
                </tr>

                <tr *ngFor="let seg of s.english.segments; let i = index; trackBy: trackById">
                    <td>{{ seg.order }}</td>
                    <td>{{ seg.name }}</td>
                    <td>{{ seg.plannedSec | mmss }}</td>

                    <!-- Actual -->
                    <td class="actual-cell">
                        <div class="actual-primary">
                            <ng-container *ngIf="isActive(i, s.english.segments); else showLockedOrBlank">
                                {{ activeElapsedSec(i, s.english.segments) | mmss }}
                            </ng-container>
                            <ng-template #showLockedOrBlank>
                                <ng-container *ngIf="seg.completed">
                                    {{ seg.actualSec | mmss }}
                                </ng-container>
                            </ng-template>
                        </div>
                    </td>

                    <td [class.under]="+(seg.driftSec ?? 0) < -4">
                        {{ seg.driftSec | signedmmss }}
                    </td>

                    <td>
                        <button (click)="complete(seg.id)" [disabled]="seg.completed">Complete</button>
                    </td>

                    <td>
                        <ng-container *ngIf="seg.completed; else dashEnded">
                            {{ endedAt(i, s.english.segments) | date:'h:mm a':'America/New_York' }}
                        </ng-container>
                        <ng-template #dashEnded>—</ng-template>
                    </td>
                </tr>
            </table>

            <audio #etaChime preload="auto">
                <source src="assets/sounds/eta-chime.wav" type="audio/wav">
            </audio>

            <!-- Toasts -->
            <div class="toast-wrap" aria-live="polite" aria-atomic="true">
                <div class="toast" *ngFor="let t of etaToasts; trackBy: trackById"
                    [class.delta-early]="t.deltaFromTarget < 0" [class.delta-late]="t.deltaFromTarget > 0">
                    <button class="toast-close" aria-label="Close" (click)="closeEtaToast(t.id)">×</button>
                    <div><b>Spanish ETA updated</b></div>
                    <div>ETA: {{ t.remSec | mmss }}</div>
                    <small class="stamp"><i>{{ t.wall | date:'h:mm a':'America/New_York' }}</i></small>
                </div>

                <div class="toast alert" *ngFor="let t of sermonEndToasts; trackBy: trackById">
                    <button class="toast-close" aria-label="Close" (click)="closeSermonEndToast(t.id)">×</button>
                    <div><b>Spanish Sermon Ended</b></div>
                    <div>
                        <small>Locked at T+{{ state?.spanish?.sermonEndedAtSec | mmss }}</small>
                        <small class="stamp"><i>{{ t.wall | date:'h:mm a':'America/New_York' }}</i></small>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>

    <!-- ================== FALLBACK (Editor) ================== -->
    <ng-template #editorFallback>
        <ng-container *ngIf="doc$ | async as doc">
            <div class="segments-wrap" style="margin:12px 0">
                <div class="segments-head">
                    <h3>Segments (Editor)</h3>
                </div>
                <table>
                    <tr>
                        <th>#</th>
                        <th>Segment</th>
                        <th>Planned</th>
                        <th>Actual</th>
                        <th>Segment Drift</th>
                        <th>Action</th>
                        <th>Ended</th>
                    </tr>
                    <tr *ngFor="let row of doc.segments; let i = index; trackBy: trackById">
                        <td>{{ i + 1 }}</td>
                        <td>{{ row.title }}</td>
                        <td>{{ row.durationSec | mmss }}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>—</td>
                    </tr>
                </table>
            </div>
        </ng-container>
    </ng-template>
</div>

