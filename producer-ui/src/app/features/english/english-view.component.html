<!-- producer.component.html -->
<div style="padding:16px" class="toolbar">
  <a class="btn btn-secondary" routerLink="/rundown">Open Service Rundown</a>
</div>

<!-- ======= PRODUCER (renders when state is available) ======= -->
<ng-container *ngIf="(state$ | async) as s; else editorFallback">
  <!-- Title / clocks / live status -->
  <div class="titlebar">
    <h2>English — Producer</h2>
    <span class="dot" [class.live]="!!s.masterStartAtUtc" [class.ended]="s.spanish?.sermonEndedAtSec"></span>

    <!-- right side clocks and last sync -->
    <div class="clock">
      <div class="stack">
        <span class="clock-time">{{ etNow$ | async }}</span>
        <span class="clock-date">{{ etDate$ | async }}</span>
      </div>
      <small class="last-sync">Last sync {{ lastSyncAgo$ | async }}s</small>
    </div>
  </div>

  <!-- Master timer line -->
  <div class="bar" *ngIf="(hub.masterCountdown$ | async) as mc">
    <b [class.time-red]="mc <= 0">Master Timer — {{ (mc > 0 ? mc : 0) | mmss }}</b>
  </div>

  <!-- Controls -->
  <div class="bar">
    <button (click)="startRun()" [disabled]="!!s.masterStartAtUtc">Start Master</button>
    <button (click)="startOffering()" [disabled]="isOfferingLocked(s)">Start Offering</button>
  </div>

  <!-- Spanish status -->
  <div class="bar">
    <b>Spanish:</b>
    <ng-container *ngIf="spanishEtaSec(s) as eta; else noEta">
      ETA {{ eta | mmss }}
    </ng-container>
    <ng-template #noEta>ETA —</ng-template>

    <span style="opacity:.6; margin:0 8px;">|</span>

    <ng-container *ngIf="spanishEndedAtWallTime() as ended; else noEnd">
      Ended at {{ ended | date:'h:mm a' }}
    </ng-container>
    <ng-template #noEnd>Ended at —</ng-template>
  </div>


  <!-- Drift + offering suggestion -->
  <div class="segments-head">
    <h3>Rundown</h3>
    <div class="total-drift">
      Total Drift:
      <span [class.under]="(s.english.runningDriftBeforeOfferingSec ?? 0) < 0"
        [class.over]="(s.english.runningDriftBeforeOfferingSec ?? 0) > 0">
        {{ (s.english.runningDriftBeforeOfferingSec ?? 0) | signedmmss }}
      </span>

      <span style="margin-left:12px" *ngIf="predictedLengthSec(s) as len">
        Suggested offering: {{ len | mmss }}
        <small *ngIf="predictedExtensionSec(s) as ext">
          <ng-container *ngIf="ext > 0">(stretch +{{ ext | mmss }})</ng-container>
        </small>
      </span>
    </div>
  </div>

  <!-- Segments table -->
  <div class="segments-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Segment</th>
          <th>Planned</th>
          <th class="actual-cell">Actual</th>
          <th>Drift</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let seg of s.english.segments; let i = index; trackBy: trackBySeg">
          <td>{{ i + 1 }}</td>
          <td [style.fontWeight]="isActive(i, s.english.segments) ? 600 : 400">{{ seg.name }}</td>
          <td>{{ seg.plannedSec | mmss }}</td>
          <td class="actual-cell">
            <div class="actual-primary">
              <ng-container *ngIf="seg.completed; else runningOrDash">
                {{ seg.actualSec | mmss }}
              </ng-container>
              <ng-template #runningOrDash>
                <ng-container *ngIf="isActive(i, s.english.segments); else dash">
                  {{ activeElapsedSec(i, s.english.segments) | mmss }}
                </ng-container>
                <ng-template #dash>—</ng-template>
              </ng-template>
            </div>
            <small *ngIf="endedAt(i, s.english.segments) as ended">
              ended {{ ended | date:'h:mm a' }}
            </small>
          </td>
          <td>
            <ng-container *ngIf="seg.driftSec != null; else nodrift">
              <span [class.under]="seg.driftSec < 0" [class.over]="seg.driftSec > 0">
                {{ seg.driftSec | signedmmss }}
              </span>
            </ng-container>
            <ng-template #nodrift>—</ng-template>
          </td>
          <td>
            <button *ngIf="!seg.completed; else done" (click)="completeSegment(seg.id)">Complete</button>
            <ng-template #done>✓</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" aria-live="polite" aria-atomic="true">
    <div class="toast" *ngFor="let t of etaToasts; trackBy: trackById" [class.delta-early]="t.deltaFromTarget < 0"
      [class.delta-late]="t.deltaFromTarget > 0">
      <div><b>Spanish ETA updated</b></div>
      <div>ETA: {{ t.remSec | mmss }}</div>
      <small class="stamp">{{ t.wall | date:'h:mm a' }}</small>
      <button class="toast-close" (click)="closeEtaToast(t.id)">×</button>
    </div>

    <div class="toast alert" *ngFor="let t of sermonEndToasts; trackBy: trackById">
      <div><b>Spanish Sermon Ended</b></div>
      <small class="stamp" *ngIf="t.wall as w"><i>{{ w | date:'h:mm:ss a' }}</i></small>
      <button class="toast-close" (click)="closeSermonEndToast(t.id)">×</button>
    </div>
  </div>

  <!-- chime -->
  <audio #etaChime preload="auto" src="assets/eta-chime.mp3"></audio>
</ng-container>

<!-- Producer Rundown (from RundownService) -->
<section *ngIf="showMiniRundown && (doc$ | async) as doc">
  <div class="segments-head">
    <h3>Rundown</h3>
    <span class="total-drift">Total: {{ totalDurationSec(doc) | mmss }}</span>
  </div>
  <div class="segments-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Start</th>
          <th>Dur</th>
          <th>End</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of doc.segments; let i = index; trackBy: trackById">
          <td>{{ i + 1 }}</td>
          <td>{{ s.title || 'Untitled' }}</td>
          <td>{{ s.startSec | mmss }}</td>
          <td>{{ s.durationSec | mmss }}</td>
          <td>{{ (s.startSec + s.durationSec) | mmss }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <ng-template #loading>Loading…</ng-template>
</section>

<!-- ================== FALLBACK (Editor) ================== -->
<ng-template #editorFallback>
  <ng-container *ngIf="doc$ | async as doc">
    <div class="segments-wrap" style="margin:12px 0">
      <div class="segments-head">
        <h3>Segments (Editor)</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Segment</th>
            <th>Planned</th>
            <th>Actual</th>
            <th>Segment Drift</th>
            <th>Action</th>
            <th>Ended</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of doc.segments; let i = index; trackBy: trackById">
            <td>{{ i + 1 }}</td>
            <td>{{ row.title }}</td>
            <td>{{ row.durationSec | mmss }}</td>
            <td></td>
            <td></td>
            <td></td>
            <td>—</td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</ng-template>